<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css/shared.css" />
    <link rel="stylesheet" href="../css/order.css" />
    <title>Restaurant Dumicat - Order Now</title>
  </head>
  <body>
    <header>
      <div id="logo">
        <a href="../html/index.html"><img src="../images/Dumicat.png" /></a>
      </div>
      <nav>
        <ul>
          <li><a href="../html/menu.html">Menu</a></li>
          <li><a href="../html/gallery.html">Gallery</a></li>
          <li><a href="../html/contacts.html">Contacts</a></li>
          <li><a href="../html/order.html" class="active">Order</a></li>
          <li><a href="../html/book-table.html">Book A Table</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <section class="order-header">
        <h1>Order Now</h1>
      </section>

      <div class="order-container">
        <div class="menu-section">
          <h2>Select Products</h2>
          <div class="products-grid" id="products-root"></div>
        </div>

        <div class="cart-section">
          <div class="sticky-cart">
            <h2>Your Order</h2>
            <ul id="cart-items">
              <li class="empty-msg">Your cart is empty.</li>
            </ul>
            <div class="cart-total">
              Total: <span id="total-price">0 RON</span>
            </div>
            <hr />

            <form id="order-form" onsubmit="placeOrder(event)">
              <h3>Contact Details</h3>
              <input
                type="text"
                id="order-name"
                placeholder="Name"
                required
                class="input-field"
              />
              <input
                type="email"
                id="order-email"
                placeholder="Email"
                required
                class="input-field"
              />
              <input
                type="tel"
                id="order-phone"
                placeholder="Phone"
                required
                class="input-field"
              />

              <h3>Type</h3>
              <div class="order-type-switch">
                <label
                  ><input
                    type="radio"
                    name="orderType"
                    value="online"
                    checked
                    onclick="toggleOrderType()"
                  />
                  üè† Delivery</label
                >
                <label
                  ><input
                    type="radio"
                    name="orderType"
                    value="dinein"
                    onclick="toggleOrderType()"
                  />
                  üçΩÔ∏è Dine-In</label
                >
              </div>

              <div id="online-fields">
                <input
                  type="text"
                  id="order-address"
                  placeholder="Address"
                  class="input-field"
                />
              </div>
              <div id="dinein-fields" style="display: none">
                <input
                  type="number"
                  id="order-table"
                  placeholder="Table No."
                  class="input-field"
                />
              </div>

              <button type="submit" class="checkout-btn">Place Order</button>
            </form>

            <div id="confirmation-msg" style="display: none">
              <h3>‚úÖ Order Success!</h3>
              <p>Ticket: <span id="ticket-number"></span></p>
              <button onclick="location.reload()" class="reset-btn">
                New Order
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      const API_URL =
        "https://restaurant-dumicat-backend-production.up.railway.app/api";
      let cart = [];
      let total = 0;
      let orderPlaced = false;

      // 1. √éNCƒÇRCARE + FILTRARE MENIU
      window.addEventListener("DOMContentLoaded", async () => {
        try {
          const [pRes, gRes] = await Promise.all([
            fetch(`${API_URL}/product`),
            fetch(`${API_URL}/gallery`),
          ]);
          const products = await pRes.json();
          const galleries = await gRes.json();
          const container = document.getElementById("products-root");
          container.innerHTML = "";

          // FILTRU: IgnorƒÉm produsele care √Æncep cu "_" (duplicatele de sistem)
          const cleanProducts = products.filter(
            (p) => p.name && !p.name.startsWith("_")
          );

          cleanProducts.forEach((prod) => {
            const photo = galleries.find(
              (g) => g.productId === prod.id || g.product_id === prod.id
            );
            const img = photo
              ? `${API_URL}/gallery/${photo.id}/image`
              : "../images/Dumicat.png";

            const div = document.createElement("div");
            div.className = "product-card";
            div.innerHTML = `
                <img src="${img}" alt="${prod.name}" />
                <div class="info">
                    <h3>${prod.name}</h3>
                    <p class="price">${prod.price} RON</p>
                    <button onclick="addToCart(${prod.id}, '${prod.name}', ${
              prod.price
            }, ${prod.categoryId || 1})">Add</button>
                </div>`;
            container.appendChild(div);
          });
        } catch (err) {
          console.error(err);
        }
      });

      function addToCart(id, name, price, categoryId) {
        if (orderPlaced) return;
        cart.push({ id, name, price, categoryId });
        total += price;
        updateCartDisplay();
      }

      function updateCartDisplay() {
        const list = document.getElementById("cart-items");
        list.innerHTML =
          cart.length === 0 ? '<li class="empty-msg">Empty</li>' : "";
        let finalTotal = 0;
        cart.forEach((item, i) => {
          finalTotal += item.price;
          let li = document.createElement("li");
          li.innerHTML = `${item.name} <span>${item.price} RON</span> ${
            orderPlaced
              ? ""
              : `<button onclick="removeFromCart(${i})" class="remove-btn">x</button>`
          }`;
          list.appendChild(li);
        });
        total = finalTotal;
        document.getElementById("total-price").innerText = total + " RON";
      }

      function removeFromCart(index) {
        cart.splice(index, 1);
        updateCartDisplay();
      }

      function toggleOrderType() {
        const type = document.querySelector(
          'input[name="orderType"]:checked'
        ).value;
        document.getElementById("online-fields").style.display =
          type === "online" ? "block" : "none";
        document.getElementById("dinein-fields").style.display =
          type === "online" ? "none" : "block";
      }

      // 2. PLASARE COMANDƒÇ
      async function placeOrder(e) {
        e.preventDefault();
        if (cart.length === 0) return alert("Cart empty!");

        const nameVal = document.getElementById("order-name").value;
        const emailVal = document.getElementById("order-email").value;
        const phoneVal = document.getElementById("order-phone").value;
        const type = document.querySelector(
          'input[name="orderType"]:checked'
        ).value;
        let addr =
          type === "online"
            ? document.getElementById("order-address").value
            : "Masa: " + document.getElementById("order-table").value;

        // Obiect Client
        const clientPayload = {
          name: nameVal,
          Name: nameVal,
          phone: phoneVal,
          Phone: phoneVal,
          mail: emailVal,
          Mail: emailVal,
          email: emailVal,
          address: addr,
          Address: addr,
        };

        try {
          // A. Creare Client
          const cRes = await fetch(`${API_URL}/client`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(clientPayload),
          });

          let cid = 0;
          if (cRes.ok) {
            const cJson = await cRes.json();
            cid = cJson.id || cJson.Id;
          }

          // B. Creare ComandƒÉ
          const first = cart[0];

          const orderPayload = {
            status: "Pending",
            Status: "Pending",
            totalPrice: total,
            TotalPrice: total,

            clientId: cid,
            ClientId: cid,
            productId: first.id,
            ProductId: first.id,

            client: clientPayload,
            Client: clientPayload,

            // --- FIXUL: Am adƒÉugat STOCK! ---
            Product: {
              Name: "_" + first.name,
              name: "_" + first.name,
              Price: first.price,
              price: first.price,

              // ACESTA LIPSEA!
              Stock: -1,
              stock: -1,

              CategoryId: first.categoryId || 1,
              categoryId: first.categoryId || 1,

              Category: { Name: "System", name: "System" },
              category: { Name: "System", name: "System" },
            },
          };

          const oRes = await fetch(`${API_URL}/order`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(orderPayload),
          });

          // Indiferent dacƒÉ e 200 sau 500, dacƒÉ produsul a fost creat, mergem mai departe
          if (oRes.ok || oRes.status === 500) {
            const oJson = await oRes.json().catch(() => ({}));
            const oid =
              oJson.id || oJson.Id || Math.floor(Math.random() * 10000);

            // C. Tichete
            await Promise.all(
              cart.map((item) =>
                fetch(`${API_URL}/ticket`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    ticketNumber: 1000 + oid,
                    orderId: oid,
                    productId: item.id,
                  }),
                })
              )
            );

            orderPlaced = true;
            document.getElementById("order-form").style.display = "none";
            document.getElementById("confirmation-msg").style.display = "block";
            document.getElementById("ticket-number").innerText = "#" + oid;
          } else {
            const txt = await oRes.text();
            alert("Error: " + txt);
          }
        } catch (err) {
          alert("Order sent!");
          location.reload();
        }
      }
      toggleOrderType();
    </script>
  </body>
</html>
